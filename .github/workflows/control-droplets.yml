name: Control Droplets (Rocket + CRM)

# CuÃ¡ndo se ejecuta
on:
  schedule:
    # Encender TODOS LOS DÃAS a las 12:30 PM UTC (7:30 AM PerÃº)
    - cron: '30 12 * * *'
    # Apagar TODOS LOS DÃAS a las 2:00 AM UTC (9:00 PM PerÃº del dÃ­a anterior)  
    - cron: '0 2 * * *'
  
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a realizar'
        required: true
        default: 'power_on'
        type: choice
        options:
        - power_on
        - shutdown
      target:
        description: 'QuÃ© droplets controlar'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - rocket
        - crm_interno
        - crm_externo

jobs:
  control-droplets:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ• Determinar acciÃ³n y droplets
        id: setup
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # EjecuciÃ³n manual
            ACTION="${{ github.event.inputs.action }}"
            TARGET="${{ github.event.inputs.target }}"
            echo "action=$ACTION" >> $GITHUB_OUTPUT
            echo "target=$TARGET" >> $GITHUB_OUTPUT
            echo "message=ğŸ”§ EjecuciÃ³n manual: $ACTION en $TARGET" >> $GITHUB_OUTPUT
          else
            # EjecuciÃ³n automÃ¡tica por horario
            HOUR=$(date +%H)
            
            if [ $HOUR -eq 12 ] && [ $(date +%M) -eq 30 ]; then
              echo "action=power_on" >> $GITHUB_OUTPUT
              echo "target=all" >> $GITHUB_OUTPUT
              echo "message=â° Encendido automÃ¡tico - 7:30 AM PerÃº TODOS LOS DÃAS (todos los droplets)" >> $GITHUB_OUTPUT
            elif [ $HOUR -eq 2 ]; then
              echo "action=shutdown" >> $GITHUB_OUTPUT
              echo "target=all" >> $GITHUB_OUTPUT
              echo "message=â° Apagado automÃ¡tico - 9:00 PM PerÃº TODOS LOS DÃAS (todos los droplets)" >> $GITHUB_OUTPUT
            else
              echo "action=none" >> $GITHUB_OUTPUT
              echo "target=none" >> $GITHUB_OUTPUT
              echo "message=ğŸ¤” No hay acciÃ³n programada para esta hora" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸš€ Controlar Droplet ROCKET
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'rocket')
        run: |
          echo "ğŸš€ Ejecutando ${{ steps.setup.outputs.action }} en ROCKET (ID: ${{ secrets.DROPLET_ID_ROCKET }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/rocket.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_ROCKET }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "âœ… ROCKET: AcciÃ³n ejecutada exitosamente"
            cat /tmp/rocket.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "ğŸ”‘ âŒ ROCKET: TOKEN INVÃLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "ğŸ” âŒ ROCKET: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_ROCKET }})"
            exit 1
          else
            echo "âŒ ROCKET: Error HTTP $response"
            cat /tmp/rocket.json
            exit 1
          fi

      - name: ğŸ¢ Controlar Droplet CRM INTERNO
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'crm_interno')
        run: |
          echo "ğŸ¢ Ejecutando ${{ steps.setup.outputs.action }} en CRM INTERNO (ID: ${{ secrets.DROPLET_ID_CRM_INTERNO }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/crm_interno.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_INTERNO }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "âœ… CRM INTERNO: AcciÃ³n ejecutada exitosamente"
            cat /tmp/crm_interno.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "ğŸ”‘ âŒ CRM INTERNO: TOKEN INVÃLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "ğŸ” âŒ CRM INTERNO: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_CRM_INTERNO }})"
            exit 1
          else
            echo "âŒ CRM INTERNO: Error HTTP $response"
            cat /tmp/crm_interno.json
            exit 1
          fi

      - name: ğŸŒ Controlar Droplet CRM EXTERNO
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'crm_externo')
        run: |
          echo "ğŸŒ Ejecutando ${{ steps.setup.outputs.action }} en CRM EXTERNO (ID: ${{ secrets.DROPLET_ID_CRM_EXTERNO }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/crm_externo.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_EXTERNO }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "âœ… CRM EXTERNO: AcciÃ³n ejecutada exitosamente"
            cat /tmp/crm_externo.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "ğŸ”‘ âŒ CRM EXTERNO: TOKEN INVÃLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "ğŸ” âŒ CRM EXTERNO: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_CRM_EXTERNO }})"
            exit 1
          else
            echo "âŒ CRM EXTERNO: Error HTTP $response"
            cat /tmp/crm_externo.json
            exit 1
          fi

      - name: ğŸ“Š Verificar estado de todos los droplets
        if: steps.setup.outputs.action != 'none'
        run: |
          echo "ğŸ“¡ Consultando estado actual de los droplets..."
          echo ""
          
          # ROCKET
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "rocket" ]; then
            echo "ğŸš€ ROCKET:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_ROCKET }}" | \
              jq -r '"  ğŸ“‹ Estado: " + .droplet.status + " | ğŸŒ IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi
          
          # CRM INTERNO
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "crm_interno" ]; then
            echo "ğŸ¢ CRM INTERNO:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_INTERNO }}" | \
              jq -r '"  ğŸ“‹ Estado: " + .droplet.status + " | ğŸŒ IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi
          
          # CRM EXTERNO
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "crm_externo" ]; then
            echo "ğŸŒ CRM EXTERNO:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_EXTERNO }}" | \
              jq -r '"  ğŸ“‹ Estado: " + .droplet.status + " | ğŸŒ IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi

      - name: ğŸ“ Resumen de ejecuciÃ³n
        if: always()
        run: |
          echo "============================================"
          echo "ğŸ“… Fecha: $(date)"
          echo "âš¡ AcciÃ³n: ${{ steps.setup.outputs.action }}"
          echo "ğŸ¯ Objetivo: ${{ steps.setup.outputs.target }}"
          echo "ğŸ’¬ ${{ steps.setup.outputs.message }}"
          echo "============================================"
