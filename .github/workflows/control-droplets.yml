name: Control Droplets (Rocket + CRM)

# Cu谩ndo se ejecuta
on:
  schedule:
    # Encender TODOS LOS DAS a las 11:30 AM UTC (6:30 AM Per煤)
    - cron: '30 11 * * *'
    # Apagar TODOS LOS DAS a las 2:00 AM UTC (9:00 PM Per煤 del d铆a anterior)  
    - cron: '0 2 * * *'
  
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:
    inputs:
      action:
        description: 'Acci贸n a realizar'
        required: true
        default: 'power_on'
        type: choice
        options:
        - power_on
        - shutdown
      target:
        description: 'Qu茅 droplets controlar'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - rocket
        - crm_interno
        - crm_externo

jobs:
  control-droplets:
    runs-on: ubuntu-latest
    steps:
      - name:  Determinar acci贸n y droplets
        id: setup
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Ejecuci贸n manual
            ACTION="${{ github.event.inputs.action }}"
            TARGET="${{ github.event.inputs.target }}"
            echo "action=$ACTION" >> $GITHUB_OUTPUT
            echo "target=$TARGET" >> $GITHUB_OUTPUT
            echo "message= Ejecuci贸n manual: $ACTION en $TARGET" >> $GITHUB_OUTPUT
          else
            # Ejecuci贸n autom谩tica por horario
            HOUR=$(date +%H)
            MINUTE=$(date +%M)
            
            # Ventana de encendido: 11:00-12:00 UTC (6:00-7:00 AM Per煤)
            if [ $HOUR -eq 11 ] || ([ $HOUR -eq 12 ] && [ $MINUTE -lt 30 ]); then
              echo "action=power_on" >> $GITHUB_OUTPUT
              echo "target=all" >> $GITHUB_OUTPUT
              echo "message= Encendido autom谩tico - 6:30 AM Per煤 TODOS LOS DAS (todos los droplets)" >> $GITHUB_OUTPUT
            # Ventana de apagado: 02:00-03:00 UTC (9:00-10:00 PM Per煤)
            elif [ $HOUR -eq 2 ] || ([ $HOUR -eq 3 ] && [ $MINUTE -lt 30 ]); then
              echo "action=shutdown" >> $GITHUB_OUTPUT
              echo "target=all" >> $GITHUB_OUTPUT
              echo "message= Apagado autom谩tico - 9:00 PM Per煤 TODOS LOS DAS (todos los droplets)" >> $GITHUB_OUTPUT
            else
              echo "action=none" >> $GITHUB_OUTPUT
              echo "target=none" >> $GITHUB_OUTPUT
              echo "message=No hay acci贸n programada para esta hora" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Controlar Droplet ROCKET
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'rocket')
        run: |
          echo "ejecutando ${{ steps.setup.outputs.action }} en ROCKET (ID: ${{ secrets.DROPLET_ID_ROCKET }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/rocket.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_ROCKET }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "ROCKET: Acci贸n ejecutada exitosamente"
            cat /tmp/rocket.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "ROCKET: TOKEN INVLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "ROCKET: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_ROCKET }})"
            exit 1
          else
            echo "ROCKET: Error HTTP $response"
            cat /tmp/rocket.json
            exit 1
          fi

      - name:  Controlar Droplet CRM INTERNO
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'crm_interno')
        run: |
          echo " Ejecutando ${{ steps.setup.outputs.action }} en CRM INTERNO (ID: ${{ secrets.DROPLET_ID_CRM_INTERNO }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/crm_interno.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_INTERNO }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "CRM INTERNO: Acci贸n ejecutada exitosamente"
            cat /tmp/crm_interno.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "CRM INTERNO: TOKEN INVLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "CRM INTERNO: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_CRM_INTERNO }})"
            exit 1
          else
            echo "CRM INTERNO: Error HTTP $response"
            cat /tmp/crm_interno.json
            exit 1
          fi

      - name:  Controlar Droplet CRM EXTERNO
        if: steps.setup.outputs.action != 'none' && (steps.setup.outputs.target == 'all' || steps.setup.outputs.target == 'crm_externo')
        run: |
          echo " Ejecutando ${{ steps.setup.outputs.action }} en CRM EXTERNO (ID: ${{ secrets.DROPLET_ID_CRM_EXTERNO }})"
          
          response=$(curl -s -w "%{http_code}" -o /tmp/crm_externo.json -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
            "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_EXTERNO }}/actions" \
            -d '{"type":"${{ steps.setup.outputs.action }}"}')
          
          if [ $response -eq 201 ]; then
            echo "CRM EXTERNO: Acci贸n ejecutada exitosamente"
            cat /tmp/crm_externo.json | jq -r '"Estado: " + .action.status'
          elif [ $response -eq 401 ]; then
            echo "CRM EXTERNO: TOKEN INVLIDO o EXPIRADO"
            exit 1
          elif [ $response -eq 404 ]; then
            echo "CRM EXTERNO: Droplet no encontrado (ID: ${{ secrets.DROPLET_ID_CRM_EXTERNO }})"
            exit 1
          else
            echo "CRM EXTERNO: Error HTTP $response"
            cat /tmp/crm_externo.json
            exit 1
          fi

      - name:  Verificar estado de todos los droplets
        if: steps.setup.outputs.action != 'none'
        run: |
          echo " Consultando estado actual de los droplets..."
          echo ""
          
          # ROCKET
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "rocket" ]; then
            echo "ROCKET:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_ROCKET }}" | \
              jq -r '" Estado: " + .droplet.status + " | IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi
          
          # CRM INTERNO
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "crm_interno" ]; then
            echo " CRM INTERNO:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_INTERNO }}" | \
              jq -r '"  Estado: " + .droplet.status + " | IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi
          
          # CRM EXTERNO
          if [ "${{ steps.setup.outputs.target }}" = "all" ] || [ "${{ steps.setup.outputs.target }}" = "crm_externo" ]; then
            echo " CRM EXTERNO:"
            curl -s -H "Authorization: Bearer ${{ secrets.DO_TOKEN }}" \
              "https://api.digitalocean.com/v2/droplets/${{ secrets.DROPLET_ID_CRM_EXTERNO }}" | \
              jq -r '"Estado: " + .droplet.status + " | IP: " + (.droplet.networks.v4[0].ip_address // "No disponible")'
            echo ""
          fi

      - name: Resumen de ejecuci贸n
        if: always()
        run: |
          echo "============================================"
          echo " Fecha: $(date)"
          echo " Acci贸n: ${{ steps.setup.outputs.action }}"
          echo " Objetivo: ${{ steps.setup.outputs.target }}"
          echo " ${{ steps.setup.outputs.message }}"
          echo "============================================"
